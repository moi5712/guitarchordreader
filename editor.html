<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>吉他譜編輯器</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- 模態視窗 -->
    <div id="customModal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3 id="modalTitle" class="modal-title"></h3>
        <p id="modalMessage" class="modal-message"></p>
        <div class="modal-actions">
          <button id="modalConfirmBtn" class="btn primary hidden">確定</button>
          <button id="modalCancelBtn" class="btn danger hidden">取消</button>
          <button id="modalAlertOkBtn" class="btn primary hidden">了解</button>
        </div>
      </div>
    </div>

    <!-- 頂部工具欄 -->
    <header class="topbar">
      <button id="homeBtn" class="btn primary">首頁</button>
      <button id="playBtn" class="btn secondary">演奏模式</button>

      <div class="sp"></div>

      <!-- 編輯工具 -->
      <button id="newBtn" class="btn-icon" title="新建">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 4.5v15m7.5-7.5h-15"
          />
        </svg>
      </button>
      <button id="importBtn" class="btn-icon" title="載入">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"
          />
        </svg>
      </button>
      <input
        id="importFile"
        type="file"
        accept=".txt,.gtab"
        style="display: none"
      />
      <button id="exportBtn" class="btn-icon" title="匯出">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"
          />
        </svg>
      </button>
      <button id="saveBtn" class="btn-icon" title="儲存">
        <svg
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          width="48px"
          height="48px"
          viewBox="0 0 24 24"
          aria-labelledby="saveIconTitle"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          fill="none"
          color="currentColor"
        >
          <title id="saveIconTitle">Save</title>
          <path
            d="M17.2928932,3.29289322 L21,7 L21,20 C21,20.5522847 20.5522847,21 20,21 L4,21 C3.44771525,21 3,20.5522847 3,20 L3,4 C3,3.44771525 3.44771525,3 4,3 L16.5857864,3 C16.8510029,3 17.1053568,3.10535684 17.2928932,3.29289322 Z"
          />
          <rect width="10" height="8" x="7" y="13" />
          <rect width="8" height="5" x="8" y="3" />
        </svg>
      </button>
      <div class="divider"></div>
      <button id="undoBtn" class="btn-icon" title="復原 (Ctrl+Z)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M7.49 12 3.74 8.248m0 0 3.75-3.75m-3.75 3.75h16.5V19.5"
          />
        </svg>
      </button>
      <button id="redoBtn" class="btn-icon" title="重做 (Ctrl+Y)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m16.49 12 3.75-3.751m0 0-3.75-3.75m3.75 3.75H3.74V19.5"
          />
        </svg>
      </button>
      <button id="clearBtn" class="btn-icon danger" title="清空內容">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
          />
        </svg>
      </button>
    </header>

    <main class="wrap">
      <div class="editor-layout">
        <!-- 左側工具欄 -->
        <div class="left-sidebar">
          <!-- 歌曲資訊 -->
          <div class="panel">
            <div class="panel-header">歌曲資訊</div>
            <div class="panel-content">
              <div class="form-group">
                <label class="form-label">歌曲名稱</label>
                <input
                  id="songTitle"
                  class="input"
                  type="text"
                  placeholder="輸入歌曲名稱"
                />
              </div>
              <div class="form-group">
                <label class="form-label">演唱者</label>
                <input
                  id="songArtist"
                  class="input"
                  type="text"
                  placeholder="輸入演唱者"
                />
              </div>
              <div class="form-group">
                <label class="form-label">調性</label>
                <select id="songKey" class="select">
                  <option value="">選擇調性</option>
                  <option value="C">C</option>
                  <option value="C#">C#</option>
                  <option value="Db">Db</option>
                  <option value="D">D</option>
                  <option value="D#">D#</option>
                  <option value="Eb">Eb</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="F#">F#</option>
                  <option value="Gb">Gb</option>
                  <option value="G">G</option>
                  <option value="G#">G#</option>
                  <option value="Ab">Ab</option>
                  <option value="A">A</option>
                  <option value="A#">A#</option>
                  <option value="Bb">Bb</option>
                  <option value="B">B</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">BPM</label>
                <input
                  id="songBpm"
                  class="input"
                  type="number"
                  placeholder="120"
                  min="60"
                  max="200"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Capo</label>
                <input
                  id="songCapo"
                  class="input"
                  type="number"
                  placeholder="0"
                  min="-2"
                  max="12"
                />
              </div>
              <button
                id="updateMetaBtn"
                class="btn primary"
                style="width: 100%"
              >
                更新資訊
              </button>
            </div>
          </div>
        </div>

        <!-- 主編輯區域 -->

        <section class="card">
          <header class="meta">
            <p class="subtitle">吉他譜編輯器</p>
          </header>

          <div id="editorView" class="editor">
            <textarea
              id="editorTextarea"
              class="editor-textarea"
              placeholder="- 使用 [和弦名] 來標記和弦位置
- 使用 [intro], [verse], [chorus], [bridge] 等來標記段落
- 支援自訂義和弦指法：@C: 0,3,2,0,1,0"
            ></textarea>
          </div>


        </section>

        <!-- 右側工具 -->
        <div class="right-sidebar">
          <!-- 段落工具 -->
          <div class="panel">
            <div class="panel-header">段落工具</div>
            <div class="panel-content">
              <div class="section-grid" id="sectionGrid"></div>
            </div>
          </div>

          <!-- 常用和弦 -->
          <div class="panel">
            <div class="panel-header">常用和弦</div>
            <div class="panel-content">
              <div class="chord-grid" id="chordGrid"></div>
            </div>
          </div>

          <!-- 自訂和弦 -->
          <div class="panel">
            <div class="panel-header">自訂和弦</div>
            <div class="panel-content">
              <div class="form-group">
                <label class="form-label">和弦名稱</label>
                <input
                  id="customChordName"
                  class="input"
                  type="text"
                  placeholder="Cmaj7"
                  style="width: 100%"
                />
              </div>
              <div class="form-group">
                <label class="form-label">指法</label>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(6, 1fr);
                    gap: 4px;
                    margin-bottom: 8px;
                  "
                >
                  <input
                    id="fret6"
                    class="input"
                    type="text"
                    placeholder="6"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                  <input
                    id="fret5"
                    class="input"
                    type="text"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                  <input
                    id="fret4"
                    class="input"
                    type="text"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                  <input
                    id="fret3"
                    class="input"
                    type="text"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                  <input
                    id="fret2"
                    class="input"
                    type="text"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                  <input
                    id="fret1"
                    class="input"
                    type="text"
                    placeholder="1"
                    style="width: 100%; text-align: center; font-size: 12px"
                  />
                </div>
                <div
                  style="
                    font-size: 12px;
                    color: var(--muted);
                    margin-bottom: 12px;
                  "
                >
                  1-12=品格位置 -1=不彈 0=空弦
                </div>
              </div>
              <button
                id="addCustomChordBtn"
                class="btn primary"
                style="width: 100%; margin-bottom: 12px"
              >
                新增自訂和弦
              </button>
              <div class="form-group">
                <div class="chord-grid" id="customChordGrid"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="functions.js"></script>
    <script>
      // 編輯器狀態
      let editorHistory = [];
      let historyIndex = -1;
      let _resolveConfirm;

      // 模態視窗函數
      function showAlert(message, title = "通知") {
        const modal = document.getElementById("customModal");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("modalConfirmBtn").classList.add("hidden");
        document.getElementById("modalCancelBtn").classList.add("hidden");
        document.getElementById("modalAlertOkBtn").classList.remove("hidden");
        modal.classList.add("visible");

        return new Promise((resolve) => {
          document.getElementById("modalAlertOkBtn").onclick = () => {
            modal.classList.remove("visible");
            resolve(true);
          };
        });
      }

      function showConfirm(message, title = "確認") {
        const modal = document.getElementById("customModal");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("modalAlertOkBtn").classList.add("hidden");
        document.getElementById("modalConfirmBtn").classList.remove("hidden");
        document.getElementById("modalCancelBtn").classList.remove("hidden");
        modal.classList.add("visible");

        return new Promise((resolve) => {
          _resolveConfirm = resolve;
          document.getElementById("modalConfirmBtn").onclick = () => {
            modal.classList.remove("visible");
            _resolveConfirm(true);
          };
          document.getElementById("modalCancelBtn").onclick = () => {
            modal.classList.remove("visible");
            _resolveConfirm(false);
          };
        });
      }

      // 編輯器功能
      function saveToHistory() {
        const content = document.getElementById("editorTextarea").value;
        if (historyIndex < editorHistory.length - 1) {
          editorHistory = editorHistory.slice(0, historyIndex + 1);
        }
        editorHistory.push(content);
        if (editorHistory.length > 50) {
          editorHistory.shift();
        } else {
          historyIndex++;
        }
      }

      function undo() {
        if (historyIndex > 0) {
          historyIndex--;
          document.getElementById("editorTextarea").value =
            editorHistory[historyIndex];
        }
      }

      function redo() {
        if (historyIndex < editorHistory.length - 1) {
          historyIndex++;
          document.getElementById("editorTextarea").value =
            editorHistory[historyIndex];
        }
      }

      function insertAtCursor(text) {
        const textarea = document.getElementById("editorTextarea");
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;

        saveToHistory();
        textarea.value =
          value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
      }

      function insertChord(chord) {
        insertAtCursor(`[${chord}]`);
      }

      function insertSection(sectionType) {
        insertAtCursor(`\n[${sectionType}]\n`);
      }

      async function updateMetaInfo() {
        const title = document.getElementById("songTitle").value;
        const artist = document.getElementById("songArtist").value;
        const key = document.getElementById("songKey").value;
        const bpm = document.getElementById("songBpm").value;
        const capo = document.getElementById("songCapo").value;

        let metaText = "";
        if (title) metaText += `#title: ${title}\n`;
        if (artist) metaText += `#artist: ${artist}\n`;
        if (key) metaText += `#key: ${key}\n`;
        if (bpm) metaText += `#bpm: ${bpm}\n`;
        if (capo) metaText += `#capo: ${capo}\n`;

        if (metaText) {
          const textarea = document.getElementById("editorTextarea");
          const currentContent = textarea.value;
          const lines = currentContent.split("\n");
          const nonMetaLines = lines.filter((line) => !line.startsWith("#"));

          saveToHistory();
          textarea.value = metaText + "\n" + nonMetaLines.join("\n");
        }
      }





      async function newDocument() {
        if (await showConfirm("確定要新建文件嗎？未保存的內容將會丟失。")) {
          saveToHistory();
          document.getElementById("editorTextarea").value = "";
          ["songTitle", "songArtist", "songKey", "songBpm", "songCapo"].forEach(
            (id) => {
              document.getElementById(id).value = "";
            }
          );
        }
      }

      async function exportDocument() {
        const content = document.getElementById("editorTextarea").value;
        if (!content.trim()) {
          await showAlert("沒有內容可以匯出");
          return;
        }

        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const title = document.getElementById("songTitle").value || "未命名";
        const artist = document.getElementById("songArtist").value || "";
        a.download = title + (artist ? " by " + artist : "") + ".gtab";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function importDocument(text) {
        saveToHistory();
        document.getElementById("editorTextarea").value = text;
        const meta = parseSheetMeta(text);

        if (meta.title) document.getElementById("songTitle").value = meta.title;
        if (meta.artist)
          document.getElementById("songArtist").value = meta.artist;
        if (meta.key) document.getElementById("songKey").value = meta.key;
        if (meta.bpm) document.getElementById("songBpm").value = meta.bpm;
        if (meta.capo) document.getElementById("songCapo").value = meta.capo;

        // 載入文件中的自定義和弦
        loadCustomChordsFromText(text);
      }

      // 自定義和弦功能
      let customChords = {};

      function addCustomChord() {
        const chordName = document
          .getElementById("customChordName")
          .value.trim();
        const fret6 = parseInt(document.getElementById("fret6").value) || 0;
        const fret5 = parseInt(document.getElementById("fret5").value) || 0;
        const fret4 = parseInt(document.getElementById("fret4").value) || 0;
        const fret3 = parseInt(document.getElementById("fret3").value) || 0;
        const fret2 = parseInt(document.getElementById("fret2").value) || 0;
        const fret1 = parseInt(document.getElementById("fret1").value) || 0;

        if (!chordName) {
          showAlert("請輸入和弦名稱");
          return;
        }

        // 驗證指法 - 允許全部空弦
        const fingering = [fret6, fret5, fret4, fret3, fret2, fret1];
        const validFrets = fingering.filter((f) => f > 0);
        const hasValidInput = fingering.some((f) => f !== 0); // 至少有一個非空弦輸入

        if (!hasValidInput) {
          showAlert("請至少輸入一個有效的指法");
          return;
        }

        // 保存自定義和弦
        customChords[chordName] = fingering;
        localStorage.setItem("customChords", JSON.stringify(customChords));

        // 添加到樂譜中
        const textarea = document.getElementById("editorTextarea");
        const currentContent = textarea.value;
        const customChordLine = `@${chordName}: ${fingering.join(",")}`;

        // 檢查是否已經存在該和弦定義
        const lines = currentContent.split("\n");
        const existingIndex = lines.findIndex((line) =>
          line.trim().startsWith(`@${chordName}:`)
        );

        if (existingIndex >= 0) {
          lines[existingIndex] = customChordLine;
        } else {
          // 找到第一個非 meta 行，在其前面插入
          let insertIndex = 0;
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() && !lines[i].trim().startsWith("#")) {
              insertIndex = i;
              break;
            }
          }
          lines.splice(insertIndex, 0, customChordLine);
        }

        saveToHistory();
        textarea.value = lines.join("\n");

        // 清空輸入框
        document.getElementById("customChordName").value = "";
        document.getElementById("fret6").value = "";
        document.getElementById("fret5").value = "";
        document.getElementById("fret4").value = "";
        document.getElementById("fret3").value = "";
        document.getElementById("fret2").value = "";
        document.getElementById("fret1").value = "";

        // 更新自定義和弦列表
        renderCustomChords();
      }

      async function deleteCustomChord(chordName) {
        if (await showConfirm(`確定要刪除和弦 "${chordName}" 嗎？`)) {
          delete customChords[chordName];
          localStorage.setItem("customChords", JSON.stringify(customChords));

          // 從樂譜中移除該和弦定義
          const textarea = document.getElementById("editorTextarea");
          const currentContent = textarea.value;
          const lines = currentContent.split("\n");
          const filteredLines = lines.filter(
            (line) => !line.trim().startsWith(`@${chordName}:`)
          );

          saveToHistory();
          textarea.value = filteredLines.join("\n");

          renderCustomChords();
        }
      }

      function renderCustomChords() {
        const customChordGrid = document.getElementById("customChordGrid");
        customChordGrid.innerHTML = "";

        Object.keys(customChords).forEach((chordName) => {
          const btn = document.createElement("button");
          btn.className = "custom-chord-btn";
          btn.textContent = chordName;

          // 添加刪除按鈕
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "×";
          deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            await deleteCustomChord(chordName);
          };
          btn.appendChild(deleteBtn);

          // 點擊插入和弦
          btn.onclick = () => insertChord(chordName);
          customChordGrid.appendChild(btn);
        });
      }

      function loadCustomChords() {
        const saved = localStorage.getItem("customChords");
        if (saved) {
          try {
            customChords = JSON.parse(saved);
            renderCustomChords();
          } catch (e) {
            console.log("無法載入自定義和弦");
          }
        }
      }

      function loadCustomChordsFromText(text) {
        const lines = text.split("\n");
        const newCustomChords = {};

        lines.forEach((line) => {
          const trimmedLine = line.trim();
          if (trimmedLine.startsWith("@")) {
            const match = trimmedLine.match(/^@([^:]+):\s*(.*)$/);
            if (match) {
              const chordName = match[1].trim();
              const fingeringStr = match[2].trim();
              try {
                const fingering = fingeringStr.split(",").map((s) => {
                  const val = s.trim();
                  return val === "-1" ? -1 : parseInt(val);
                });

                if (
                  fingering.length === 6 &&
                  fingering.every(
                    (f) => Number.isInteger(f) && f >= -1 && f <= 12
                  )
                ) {
                  newCustomChords[chordName] = fingering;
                }
              } catch (e) {
                console.log(`解析指法失敗: ${line}`);
              }
            }
          }
        });

        // 合併新的自定義和弦
        customChords = { ...customChords, ...newCustomChords };
        localStorage.setItem("customChords", JSON.stringify(customChords));
        renderCustomChords();
      }

      // 儲存功能
      async function saveToSheetsFolder() {
        const content = document.getElementById("editorTextarea").value;
        if (!content.trim()) {
          alert("請先輸入樂譜內容");
          return;
        }

        let fullFilename;

        if (currentFilename) {
          // 如果有原始檔案名稱，詢問是否覆蓋
          const overwrite = confirm(`是否覆蓋原檔案「${currentFilename}」？\n點擊「確定」覆蓋，點擊「取消」另存新檔。`);

          if (overwrite) {
            fullFilename = currentFilename;
          } else {
            const filename = prompt("請輸入檔案名稱（不含副檔名）：");
            if (!filename) return;
            const extension = currentFilename.includes(".gtab") ? ".gtab" : ".txt";
            fullFilename = filename + extension;
          }
        } else {
          // 沒有原始檔案名稱，詢問新檔案名稱
          const filename = prompt("請輸入檔案名稱（不含副檔名）：");
          if (!filename) return;
          const extension = ".txt"; // 預設儲存為txt格式
          fullFilename = filename + extension;
        }

        try {
          const response = await fetch("/api/save-sheet", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              filename: fullFilename,
              content: content,
            }),
          });

          if (response.ok) {
            alert(`檔案已儲存：${fullFilename}`);
            // 更新當前檔案名稱
            currentFilename = fullFilename;
          } else {
            alert("儲存失敗");
          }
        } catch (error) {
          console.error("儲存錯誤:", error);
          alert("儲存失敗");
        }
      }

      // 全域變數儲存當前檔案名稱
      let currentFilename = null;

      // 初始化
      function init() {
        // 設置初始編輯模式
        document.body.classList.add("editor-mode");

        // 檢查URL參數
        const urlParams = new URLSearchParams(window.location.search);
        const contentParam = urlParams.get('content');
        const filenameParam = urlParams.get('filename');

        if (contentParam) {
          // 從URL載入內容
          const content = decodeURIComponent(contentParam);
          document.getElementById("editorTextarea").value = content;

          // 儲存檔案名稱
          if (filenameParam) {
            currentFilename = decodeURIComponent(filenameParam);
          }

          // 載入內容中的自定義和弦
          loadCustomChordsFromText(content);
        } else {
          // 恢復之前保存的編輯內容
          const savedContent = localStorage.getItem("editorContent");
          if (savedContent) {
            document.getElementById("editorTextarea").value = savedContent;
            // 載入內容中的自定義和弦
            loadCustomChordsFromText(savedContent);
          }
        }

        // 生成段落按鈕
        const sectionGrid = document.getElementById("sectionGrid");
        SECTION_TYPES.forEach((section) => {
          const btn = document.createElement("button");
          btn.className = `section-btn ${section.class}`;
          btn.textContent = section.name;
          btn.onclick = () => insertSection(section.key);
          sectionGrid.appendChild(btn);
        });

        // 生成和弦按鈕
        const chordGrid = document.getElementById("chordGrid");
        COMMON_CHORDS.forEach((chord) => {
          const btn = document.createElement("button");
          btn.className = "chord-btn";
          btn.textContent = chord;
          btn.onclick = () => insertChord(chord);
          chordGrid.appendChild(btn);
        });

        saveToHistory();

        // 事件綁定
        document.getElementById("homeBtn").onclick = () => {
          window.location.href = "library.html";
        };

        document.getElementById("playBtn").onclick = () => {
          // 保存當前編輯內容到 localStorage，並以標題簡化網址
          const currentContent = document.getElementById("editorTextarea").value;
          localStorage.setItem("editorContent", currentContent);
          localStorage.setItem("currentSheetContent", currentContent);

          // 從內容解析標題，作為網址顯示
          const meta = parseSheetMeta(currentContent || "");
          const title = (meta && meta.title) ? meta.title : "未命名";

          window.location.href = `reader.html?${encodeURIComponent(title)}`;
        };

        document.getElementById("newBtn").onclick = newDocument;
        document.getElementById("exportBtn").onclick = exportDocument;
        document.getElementById("importBtn").onclick = () =>
          document.getElementById("importFile").click();
        document.getElementById("undoBtn").onclick = undo;
        document.getElementById("redoBtn").onclick = redo;
        document.getElementById("clearBtn").onclick = async () => {
          if (await showConfirm("確定要清空所有內容嗎？")) {
            saveToHistory();
            document.getElementById("editorTextarea").value = "";
          }
        };
        document.getElementById("updateMetaBtn").onclick = updateMetaInfo;

        // 自定義和弦功能
        document.getElementById("addCustomChordBtn").onclick = addCustomChord;

        // 載入已保存的自定義和弦
        loadCustomChords();

        // 儲存按鈕事件
        document.getElementById("saveBtn").onclick = saveToSheetsFolder;

        document
          .getElementById("importFile")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
              importDocument(evt.target.result);
            };
            reader.readAsText(file, "utf-8");
          });



        // 鍵盤快捷鍵
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey || e.metaKey) {
            if (e.key === "z" && !e.shiftKey) {
              e.preventDefault();
              undo();
            } else if (e.key === "y" || (e.key === "z" && e.shiftKey)) {
              e.preventDefault();
              redo();
            } else if (e.key === "s") {
              e.preventDefault();
              exportDocument();
            } else if (e.key === "n") {
              e.preventDefault();
              newDocument();
            }
          }
        });
      }

      window.onload = init;
    </script>
  </body>
</html>
